<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Cloud To-Do List</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        form { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background: #fafafa; }
        input[type="text"], textarea { width: calc(100% - 22px); padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #4cae4c; }
        .task-list { list-style: none; padding: 0; }
        .task-card { 
            display: flex; 
            align-items: center; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 1px solid #eee; 
            border-left: 5px solid #007bff; 
            border-radius: 4px; 
            background: #fff;
            transition: all 0.3s ease;
        }
        .task-content { flex-grow: 1; margin-right: 15px; }
        .task-content h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        .task-done { border-left-color: #5cb85c; opacity: 0.6; }
        .task-done h3, .task-done p { text-decoration: line-through; color: #777; }
        .flash { padding: 10px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; }
        .flash.error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
        .flash.success { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –æ—à–∏–±–∫–∏ –ø—É—Å—Ç–æ–≥–æ –ø–æ–ª—è –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π */
        #error-output { color: #a94442; font-weight: bold; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cloud To-Do List</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form id="add-task-form" method="POST" action="{{ url_for('add_task') }}">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—É—é –ó–∞–¥–∞—á—É</h2>
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ó–∞–¥–∞—á–∏:</label>
            <input type="text" id="title" name="title" placeholder="–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫" required>
            
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –ó–∞–¥–∞—á–∏:</label>
            <textarea id="description" name="description" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..." required></textarea>
            
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ó–∞–¥–∞—á—É</button>
            
            <div id="error-output">
                üö´ –û—à–∏–±–∫–∞: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è. –ó–∞–¥–∞—á–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.
            </div>
        </form>

        <h2>–°–ø–∏—Å–æ–∫ –ó–∞–¥–∞—á</h2>
        <ul class="task-list">
            {% if tasks %}
                {% for task in tasks %}
                    <li class="task-card {% if task.is_done %}task-done{% endif %}">
                        <div class="task-content">
                            <h3>{{ task.title }}</h3>
                            <p>{{ task.description }}</p>
                        </div>
                        
                        <input 
                            type="checkbox" 
                            name="is_done" 
                            data-task-id="{{ task.id }}"
                            {% if task.is_done %}checked{% endif %}
                            onchange="updateTaskStatus(this)"
                        >
                    </li>
                {% endfor %}
            {% else %}
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á. –ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π!</p>
            {% endif %}
        </ul>
    </div>

    <script>
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é)
        document.getElementById('add-task-form').addEventListener('submit', function(event) {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const errorOutput = document.getElementById('error-output');

            if (title === '' || description === '') {
                event.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                errorOutput.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            } else {
                errorOutput.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –≤—Å–µ –û–ö
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ Cloud Function –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
        function updateTaskStatus(checkbox) {
            const taskId = checkbox.getAttribute('data-task-id');
            const isDone = checkbox.checked;
            
            // !!! –í–ê–ñ–ù–û: URL Cloud Function –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è !!!
            const CLOUD_FUNCTION_URL = 'https://us-central1-kbtu-cloud-dev-us.cloudfunctions.net/updateTaskStatus';

            fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: taskId,
                    is_done: isDone
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–°–±–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
                // –î–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const card = checkbox.closest('.task-card');
                if (isDone) {
                    card.classList.add('task-done');
                } else {
                    card.classList.remove('task-done');
                }
                console.log(`–ó–∞–¥–∞—á–∞ ${taskId} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${isDone}`);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                checkbox.checked = !isDone; 
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cloud Function.');
            });
        }
    </script>
</body>
</html>